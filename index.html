<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="åŸºäºGISå’ŒåœŸå£¤å…»åˆ†æ•°æ®åº“çš„æ™ºèƒ½æ–½è‚¥æ¨èç³»ç»Ÿï¼Œä¸ºé•¿æ±Ÿä¸­ä¸‹æ¸¸åœ°åŒºæä¾›ç²¾å‡†æ–½è‚¥æ–¹æ¡ˆ">
    <meta name="keywords" content="æ–½è‚¥æ¨è,ç²¾å‡†å†œä¸š,åœŸå£¤å…»åˆ†,æ°´ç¨»,å°éº¦">
    <title>ç§‘å­¦æ–½è‚¥æ¨èç³»ç»Ÿ - æ™ºèƒ½å†œä¸šæ–½è‚¥å†³ç­–å¹³å°</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ==================== CSS Variables ==================== */
        :root {
            --primary: #28a745;
            --primary-dark: #218838;
            --primary-light: #d4edda;
            --secondary: #6c757d;
            --light: #f8f9fa;
            --dark: #343a40;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --success: #28a745;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Border Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }
        
        /* ==================== Base Styles ==================== */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* ==================== Navbar Styles ==================== */
        .navbar {
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-md);
            transition: var(--transition-normal);
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary) !important;
            transition: var(--transition-fast);
        }
        
        .navbar-brand:hover {
            transform: translateY(-2px);
        }
        
        .navbar-brand i {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .nav-link {
            color: var(--dark) !important;
            font-weight: 500;
            transition: var(--transition-fast);
            position: relative;
            padding: 0.5rem 1rem;
        }
        
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: var(--transition-normal);
            transform: translateX(-50%);
        }
        
        .nav-link:hover::after {
            width: 80%;
        }
        
        /* ==================== Card Styles ==================== */
        .card {
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: none;
            transition: var(--transition-normal);
            background: white;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            border: none;
            padding: var(--spacing-lg);
            font-weight: 600;
        }
        
        .card-header:not([class*="bg-"]) {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        /* ==================== Form Styles ==================== */
        .form-control, .form-select {
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            transition: var(--transition-fast);
            font-size: 0.95rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.15);
        }
        
        .form-control:invalid {
            border-color: var(--danger);
        }
        
        .form-label {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: var(--spacing-sm);
        }
        
        .form-text {
            font-size: 0.85rem;
            color: var(--secondary);
        }
        
        /* Required field indicator */
        .form-label .text-danger {
            color: var(--danger);
        }
        
        /* ==================== Button Styles ==================== */
        .btn {
            border-radius: var(--radius-md);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: var(--transition-fast);
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline-primary:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        
        /* ==================== Crop Selection Cards ==================== */
        .crop-selection-card {
            cursor: pointer;
            transition: var(--transition-normal);
            border: 2px solid transparent;
            height: 100%;
        }
        
        .crop-selection-card:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .form-check-input[type="radio"]:checked ~ .crop-selection-card {
            border-color: var(--primary);
            background: var(--primary-light);
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.15);
        }
        
        .crop-icon {
            font-size: 2.5rem;
            margin-right: var(--spacing-md);
            transition: var(--transition-normal);
        }
        
        .crop-selection-card:hover .crop-icon {
            transform: scale(1.2) rotate(5deg);
        }
        
        /* ==================== Toggle Switch ==================== */
        .toggle-switch {
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
        }
        
        .toggle-switch input {
            display: none;
        }
        
        .toggle-slider {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 28px;
            background-color: #ccc;
            border-radius: 14px;
            transition: var(--transition-normal);
            margin-right: var(--spacing-md);
        }
        
        .toggle-slider::before {
            content: "";
            position: absolute;
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(28px);
        }
        
        /* ==================== Soil Input Section ==================== */
        .soil-input-section {
            border-left: 4px solid #ff9800;
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.05), rgba(255, 152, 0, 0.02));
            border-radius: var(--radius-md);
            transition: var(--transition-normal);
        }
        
        .soil-input-section.active {
            box-shadow: var(--shadow-md);
        }
        
        /* ==================== Result Section ==================== */
        .result-section {
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-card {
            margin-bottom: var(--spacing-lg);
            border-left: 4px solid var(--primary);
        }
        
        .fertilizer-card {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-left-color: var(--success);
        }
        
        .advice-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left-color: var(--info);
        }
        
        .param-card {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-left-color: #9c27b0;
        }
        
        .soil-card {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-left-color: #ff9800;
        }
        
        /* ==================== Section Title ==================== */
        .section-title {
            position: relative;
            padding-bottom: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            font-weight: 700;
            color: var(--dark);
            font-size: 1.25rem;
        }
        
/*         .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), transparent);
            border-radius: 2px;
        } */
        
        /* ==================== Badges ==================== */
        .nutrient-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: var(--spacing-sm);
            display: inline-block;
            transition: var(--transition-fast);
        }
        
        .nutrient-badge:hover {
            transform: scale(1.05);
        }
        
        .nutrient-low { 
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white; 
        }
        
        .nutrient-medium { 
            background: linear-gradient(135deg, #ffd93d, #ffb800);
            color: #333; 
        }
        
        .nutrient-high { 
            background: linear-gradient(135deg, #6bcf7f, #51cf66);
            color: white; 
        }
        
        .nutrient-very-high { 
            background: linear-gradient(135deg, #4d96ff, #1e88e5);
            color: white; 
        }
        
        .nutrient-default { 
            background: linear-gradient(135deg, #adb5bd, #868e96);
            color: white; 
        }
        
        /* ==================== Status Indicators ==================== */
        .server-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 0.75rem 1.25rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            transition: var(--transition-normal);
            animation: slideInRight 0.5s ease;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .status-online {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .status-offline {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .status-checking {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #212529;
        }
        
        /* ==================== Loading Spinner ==================== */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
        }
        
        .spinner-border {
            width: 4rem;
            height: 4rem;
            border-width: 0.4rem;
        }
        
        .loading-text {
            margin-top: var(--spacing-lg);
            font-size: 1.1rem;
            color: var(--secondary);
            animation: pulse-text 1.5s infinite;
        }
        
        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ==================== Alerts ==================== */
        .alert {
            border-radius: var(--radius-md);
            border: none;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        
        .alert-info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }
        
        .offline-alert {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
            width: 90%;
            max-width: 600px;
            display: none;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        /* ==================== Location Controls ==================== */
        .location-btn {
            margin-top: var(--spacing-sm);
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            width: 100%;
        }
        
        .location-status {
            font-size: 0.85rem;
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
        }
        
        .location-success {
            color: var(--success);
            background: rgba(40, 167, 69, 0.1);
        }
        
        .location-error {
            color: var(--danger);
            background: rgba(220, 53, 69, 0.1);
        }
        
        /* ==================== Footer ==================== */
        footer {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 3rem 0;
            margin-top: 4rem;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        
        footer h5 {
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
        }
        
        footer a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition-fast);
        }
        
        footer a:hover {
            color: white;
            text-decoration: underline;
        }
        
        /* ==================== Responsive Design ==================== */
        @media (max-width: 768px) {
            .card {
                margin-bottom: var(--spacing-lg);
            }
            
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .server-status {
                bottom: 10px;
                right: 10px;
                font-size: 0.75rem;
                padding: 0.5rem 1rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            
            .offline-alert {
                top: 70px;
            }
        }
        
        /* ==================== Accessibility ==================== */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus styles for keyboard navigation */
        *:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* ==================== Print Styles ==================== */
        @media print {
            .navbar,
            .server-status,
            .offline-alert,
            .btn,
            footer {
                display: none !important;
            }
            
            .card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            body {
                background: white;
            }
        }
        
        /* ==================== Utility Classes ==================== */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-up {
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* åœ°å›¾å®¹å™¨æ ·å¼ */
        #mapContainer {
            width: 100%;
            height: 400px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-lg);
            background: #e9ecef;
            transition: all 0.3s ease;
        }
        
        /* åœ°å›¾æŠ˜å çŠ¶æ€ */
        #mapContainer.map-container-collapsed {
            height: 0;
            margin-bottom: 0;
            opacity: 0;
            display: none;
        }
        
        /* åœ°å›¾å±•å¼€çŠ¶æ€ */
        #mapContainer.map-container-expanded {
            height: 400px;
            opacity: 1;
            display: block;
        }
        
        /* åœ°å›¾æ§åˆ¶æŒ‰é’®åœ¨æŠ˜å æ—¶éšè— */
        #mapContainer.map-container-collapsed ~ #mapControlButtons,
        #mapContainer.map-container-collapsed ~ #mapInfoBox {
            display: none;
        }
        
        /* åœ°å›¾ä½ç½®æ˜¾ç¤ºåœ¨æŠ˜å æ—¶ä¹Ÿéšè— */
        #mapContainer.map-container-collapsed ~ #mapLocationInfo {
            display: none !important;
        }

        /* åœ°å›¾ä¿¡æ¯æ¡† */
        .map-info-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-left: 4px solid var(--info);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            transition: all 0.3s ease;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #mapContainer {
                height: 300px;
            }
            
            #mapContainer.map-container-expanded {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- æœåŠ¡å™¨çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="server-status status-checking" id="serverStatus" role="status" aria-live="polite">
        <i class="fas fa-spinner fa-spin me-2"></i>æ£€æŸ¥æœåŠ¡å™¨è¿æ¥...
    </div>
    
    <!-- ç¦»çº¿æ¨¡å¼æç¤º -->
    <div class="alert alert-warning offline-alert" id="offlineAlert" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
            <div>
                <h6 class="mb-1">ç¦»çº¿æ¨¡å¼</h6>
                <p class="mb-0">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨,æ­£åœ¨ä½¿ç”¨ç¦»çº¿æ¨¡æ‹Ÿæ•°æ®ã€‚è®¡ç®—ç»“æœä»…ä¾›å‚è€ƒã€‚</p>
            </div>
            <button type="button" class="btn-close ms-auto" onclick="hideOfflineAlert()" aria-label="å…³é—­"></button>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white py-3 sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#" aria-label="ç§‘å­¦æ–½è‚¥æ¨èç³»ç»Ÿé¦–é¡µ">
                <i class="fas fa-seedling me-2"></i>ç§‘å­¦æ–½è‚¥æ¨èç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆª">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="aboutLink">
                            <i class="fas fa-info-circle me-1"></i>ä½¿ç”¨è¯´æ˜
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="techLink">
                            <i class="fas fa-book me-1"></i>æŠ€æœ¯åŸç†
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="contactLink">
                            <i class="fas fa-phone me-1"></i>è”ç³»æˆ‘ä»¬
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- ä¸»è¡¨å•å¡ç‰‡ -->
                <div class="card mb-4 fade-in">
                    <div class="card-header text-center py-5">
                        <h2 class="mb-2">
                            <i class="fas fa-leaf me-2"></i>åŸºäºèŒ¬å£ï¼Œåœ°åŠ›çš„ç›®æ ‡äº§é‡éº¦ç¨»æ–½è‚¥æ¨èç³»ç»Ÿ
                        </h2>
                      <!-- <p class="mb-0 mt-2 opacity-75">åŸºäºåœ°ç†ä½ç½®çš„æ™ºèƒ½æ–½è‚¥æ¨èç³»ç»Ÿ</p>  -->
                    </div>
                    <div class="card-body p-4">
                        <form id="fertilizerForm" novalidate>
                            <!-- åœ°å—ä½ç½®é€‰æ‹© -->
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <h5 class="mb-0 fw-bold">
                                        <i class="fas fa-map-marked-alt me-2"></i>åœ°å—ä½ç½®é€‰æ‹©
                                    </h5>
                                </div>
                                <p class="text-muted small mb-4">
                                    <i class="fas fa-info-circle me-1"></i>
                                    è¯·é€‰æ‹©ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€æ¥ç¡®å®šç”°å—ä½ç½®ã€‚æ”¯æŒæ‰‹åŠ¨è¾“å…¥ç»çº¬åº¦æˆ–åœ¨åœ°å›¾ä¸Šé€‰ç‚¹ã€‚
                                </p>
                            </div>
                            
                            <!-- é€‰é¡¹ 1: åœ°å›¾é€‰ç‚¹ -->
                            <div class="card mb-4 border-success">
                                <div class="card-header bg-success bg-opacity-10 border-success">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0 fw-bold text-success">
                                            <span class="badge bg-success me-2">é€‰é¡¹ 1</span>
                                            <i class="fas fa-map-marked-alt me-2"></i>åœ°å›¾é€‰ç‚¹
                                        </h5>
                                        <button type="button" class="btn btn-sm btn-outline-success" id="toggleMapBtn">
                                            <i class="fas fa-chevron-up me-1"></i>æŠ˜å åœ°å›¾
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" id="mapCardBody" style="display: block;">
                                    <!-- æ§åˆ¶æŒ‰é’® -->
                                    <div class="d-flex gap-2 mb-3" id="mapControlButtons" style="display: flex;">
                                        <button type="button" class="btn btn-sm btn-outline-success" id="reloadMapBtn">
                                            <i class="fas fa-redo me-1"></i>é‡æ–°åŠ è½½åœ°å›¾
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" id="relocateBtn">
                                            <i class="fas fa-location-arrow me-1"></i>é‡æ–°å®šä½
                                        </button>
                                    </div>

                                    <!-- åœ°å›¾å®¹å™¨ -->
                                    <div id="mapContainer" class="map-container-expanded"></div>

                                    <!-- åœ°å›¾ä¿¡æ¯æç¤º -->
                                    <div class="mt-3">
                                        <div class="d-flex align-items-center" style="cursor: pointer;" id="mapInfoToggle">
                                            <i class="fas fa-info-circle me-2 text-success"></i>
                                            <span class="fw-bold text-success">åœ°å›¾é€‰ç‚¹è¯´æ˜</span>
                                            <i class="fas fa-chevron-down ms-2 text-success" id="mapInfoToggleIcon"></i>
                                        </div>
                                        <div class="map-info-box mt-2" id="mapInfoBox" style="display: none;">
                                            <ul class="mb-0 small">
                                                <li>ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®æˆ–ä½¿ç”¨GPSå®šä½ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ›´æ–°ç»çº¬åº¦</li>
                                                <li>æ”¯æŒæœç´¢åŸå¸‚ã€åœ°å€å¿«é€Ÿå®šä½</li>
                                                <li class="text-warning">âš ï¸ åæ ‡èŒƒå›´å¿…é¡»åœ¨é•¿æ±Ÿä¸­ä¸‹æ¸¸åœ°åŒº (ç»åº¦110-122Â°, çº¬åº¦28-33Â°)</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- åœ°å›¾é€‰ç‚¹çš„åæ ‡æ˜¾ç¤º -->
                                    <div class="alert alert-info mt-3" id="mapLocationInfo" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-map-pin me-2 fs-5"></i>
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">åœ°å›¾é€‰ç‚¹ä½ç½®:</div>
                                                <div class="map-marker-info" id="mapLocationText"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- é€‰é¡¹ 2: æ‰‹åŠ¨è¾“å…¥ç»çº¬åº¦ -->
                            <div class="card mb-4 border-success">
                                <div class="card-header bg-success bg-opacity-10 border-success">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0 fw-bold text-success">
                                            <span class="badge bg-success me-2">é€‰é¡¹ 2</span>
                                            <i class="fas fa-keyboard me-2"></i>æ‰‹åŠ¨è¾“å…¥ç»çº¬åº¦
                                        </h5>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleCoordBtn">
                                            <i class="fas fa-chevron-down me-1"></i>å±•å¼€
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" id="coordContainer" style="display: none;">
                                    <p class="text-muted small mb-3">
                                        <i class="fas fa-info-circle me-1"></i>
                                        ç›´æ¥è¾“å…¥ç»çº¬åº¦åæ ‡æˆ–ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©åŸå¸‚
                                    </p>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="lonInput" class="form-label fw-bold">
                                                ç»åº¦ <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                </span>
                                                <input type="number"
                                                       class="form-control"
                                                       id="lonInput"
                                                       step="0.0001"
                                                       min="110"
                                                       max="122"
                                                       required
                                                       aria-describedby="lonHelp">
                                            </div>
                                            <div id="lonHelp" class="form-text">
                                                <i class="fas fa-compass me-1"></i>èŒƒå›´: 110-122Â°
                                            </div>
                                            <button type="button" class="btn btn-outline-success location-btn btn-sm mt-2" id="getLocationBtn">
                                                <i class="fas fa-location-arrow me-1"></i>ä½¿ç”¨å½“å‰ä½ç½®
                                            </button>
                                            <div class="location-status" id="locationStatus" role="status" aria-live="polite"></div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="latInput" class="form-label fw-bold">
                                                çº¬åº¦ <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                </span>
                                                <input type="number"
                                                       class="form-control"
                                                       id="latInput"
                                                       step="0.0001"
                                                       min="28"
                                                       max="33"
                                                       required
                                                       aria-describedby="latHelp">
                                            </div>
                                            <div id="latHelp" class="form-text">
                                                <i class="fas fa-compass me-1"></i>èŒƒå›´: 28-33Â°
                                            </div>
                                            <button type="button" class="btn btn-outline-secondary location-btn btn-sm mt-2" id="selectCityBtn">
                                                <i class="fas fa-city me-1"></i>é€‰æ‹©åŸå¸‚
                                            </button>
                                            <select class="form-select mt-2" id="citySelect" style="display: none;" aria-label="é€‰æ‹©åŸå¸‚">
                                                <option value="">é€‰æ‹©åŸå¸‚...</option>
                                                <option value="å—äº¬">å—äº¬</option>
                                                <option value="æ­¦æ±‰">æ­¦æ±‰</option>
                                                <option value="é•¿æ²™">é•¿æ²™</option>
                                                <option value="å—æ˜Œ">å—æ˜Œ</option>
                                                <option value="æ­å·">æ­å·</option>
                                                <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                                                <option value="åˆè‚¥">åˆè‚¥</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- å½“å‰é€‰æ‹©çš„åæ ‡æ˜¾ç¤º -->
                                    <div class="alert alert-info mt-3" id="manualLocationInfo" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-map-pin me-2 fs-5"></i>
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">å½“å‰ä½ç½®:</div>
                                                <div class="location-marker-info" id="manualLocationText"></div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            
                            <!-- ä½œç‰©ç±»å‹é€‰æ‹© -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    ä½œç‰©ç±»å‹ <span class="text-danger">*</span>
                                </label>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <input class="form-check-input d-none" type="radio" name="crop" id="rice" value="æ°´ç¨»" checked required>
                                        <label class="crop-selection-card card p-3" for="rice">
                                            <div class="d-flex align-items-center">
                                                <i class="crop-icon">ğŸŒ¾</i>
                                                <div>
                                                    <h5 class="mb-1">æ°´ç¨»</h5>
                                                    <p class="text-muted mb-0 small">é€‚ç”¨äºé•¿æ±Ÿä¸­ä¸‹æ¸¸ç¨»åŒº</p>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <input class="form-check-input d-none" type="radio" name="crop" id="wheat" value="å°éº¦" required>
                                        <label class="crop-selection-card card p-3" for="wheat">
                                            <div class="d-flex align-items-center">
                                                <i class="crop-icon">ğŸŒ¿</i>
                                                <div>
                                                    <h5 class="mb-1">å°éº¦</h5>
                                                    <p class="text-muted mb-0 small">é€‚ç”¨äºé•¿æ±Ÿä¸­ä¸‹æ¸¸éº¦åŒº</p>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- åŸºæœ¬å‚æ•° -->
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <label for="yieldInput" class="form-label fw-bold">
                                        é¢„æœŸäº§é‡ (å…¬æ–¤/äº©) <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number"
                                               class="form-control"
                                               id="yieldInput"
                                               min="100"
                                               max="1000"
                                               value="500"
                                               required
                                               aria-describedby="yieldHelp">
                                        <button type="button"
                                                class="btn btn-outline-primary"
                                                id="getPotentialYieldBtn"
                                                title="æ ¹æ®å½“å‰ä½ç½®è·å–GAEZæ½œåœ¨äº§é‡">
                                            <i class="fas fa-chart-line"></i>
                                        </button>
                                    </div>
                                    <div id="yieldHelp" class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>è¯·è¾“å…¥100-1000ä¹‹é—´çš„äº§é‡å€¼ï¼Œæˆ–ç‚¹å‡»å³ä¾§æŒ‰é’®è·å–GAEZæ½œåœ¨äº§é‡
                                    </div>
                                    <div class="invalid-feedback">
                                        è¯·è¾“å…¥æœ‰æ•ˆçš„äº§é‡å€¼(100-1000å…¬æ–¤/äº©)
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="dateInput" class="form-label fw-bold">
                                        æ’­ç§æ—¥æœŸ <span class="text-danger">*</span>
                                    </label>
                                    <input type="date"
                                           class="form-control"
                                           id="dateInput"
                                           required
                                           aria-describedby="dateHelp">
                                    <div id="dateHelp" class="form-text">
                                        <i class="fas fa-calendar me-1"></i>è¯·é€‰æ‹©è®¡åˆ’æ’­ç§æ—¥æœŸ
                                    </div>
                                    <div class="invalid-feedback">
                                        è¯·é€‰æ‹©æ’­ç§æ—¥æœŸ
                                    </div>
                                </div>
                            </div>
                            
                            <!-- åœŸå£¤å…»åˆ†è¾“å…¥é€‰é¡¹ -->
                            <div class="soil-input-section" id="soilInputSection">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0 fw-bold">
                                        <i class="fas fa-vial me-2"></i>åœŸå£¤å…»åˆ†è¾“å…¥
                                    </h5>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="customSoilToggle" aria-label="åˆ‡æ¢æ‰‹åŠ¨è¾“å…¥åœŸå£¤å…»åˆ†">
                                        <span class="toggle-slider"></span>
                                        <span class="fw-medium">æ‰‹åŠ¨è¾“å…¥åœŸå£¤å…»åˆ†å€¼</span>
                                    </label>
                                </div>
                                <p class="text-muted small mb-3">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    å¦‚æœä¸å¡«å†™,ç³»ç»Ÿå°†æ ¹æ®ç»çº¬åº¦ä»åœŸå£¤æ•°æ®åº“è‡ªåŠ¨è·å–
                                </p>
                                
                                <div class="row" id="soilInputs" style="display: none;">
                                    <div class="col-md-4 mb-3">
                                        <label for="soilNInput" class="form-label fw-medium">
                                            ç¢±è§£æ°® (N) <span class="text-muted small">(å¯é€‰)</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="soilNInput" 
                                                   min="0" 
                                                   max="300" 
                                                   step="0.1" 
                                                   placeholder="è‡ªåŠ¨è·å–"
                                                   aria-describedby="soilNHelp">
                                            <span class="input-group-text">mg/kg</span>
                                        </div>
                                        <div id="soilNHelp" class="form-text small">èŒƒå›´: 0-300 mg/kg</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="soilPInput" class="form-label fw-medium">
                                            æœ‰æ•ˆç£· (P) <span class="text-muted small">(å¯é€‰)</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="soilPInput" 
                                                   min="0" 
                                                   max="100" 
                                                   step="0.1" 
                                                   placeholder="è‡ªåŠ¨è·å–"
                                                   aria-describedby="soilPHelp">
                                            <span class="input-group-text">mg/kg</span>
                                        </div>
                                        <div id="soilPHelp" class="form-text small">èŒƒå›´: 0-100 mg/kg</div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="soilKInput" class="form-label fw-medium">
                                            æœ‰æ•ˆé’¾ (K) <span class="text-muted small">(å¯é€‰)</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="soilKInput" 
                                                   min="0" 
                                                   max="500" 
                                                   step="0.1" 
                                                   placeholder="è‡ªåŠ¨è·å–"
                                                   aria-describedby="soilKHelp">
                                            <span class="input-group-text">mg/kg</span>
                                        </div>
                                        <div id="soilKHelp" class="form-text small">èŒƒå›´: 0-500 mg/kg</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- åœ°ç†ä¿¡æ¯æ˜¾ç¤º -->
                            <div class="alert alert-info mt-3" id="locationInfo" style="display: none;" role="status">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-map-marker-alt me-2 fs-5"></i>
                                    <div>
                                        <span id="locationText"></span>
                                        <div class="mt-1 small" id="soilDataStatus"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <i class="fas fa-database me-2"></i>
                                <span class="fw-bold">æ•°æ®è¯´æ˜:</span>
                                ç³»ç»Ÿæ ¹æ®æ‚¨è¾“å…¥çš„ç»çº¬åº¦ä»åœŸå£¤æ•°æ®åº“ä¸­è·å–ç¢±è§£æ°®ã€æœ‰æ•ˆç£·ã€æœ‰æ•ˆé’¾å«é‡,ç”¨äºç²¾å‡†è®¡ç®—æ–½è‚¥æ–¹æ¡ˆã€‚æ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©æ‰‹åŠ¨è¾“å…¥åœŸå£¤å…»åˆ†æ•°æ®ã€‚
                            </div>

                            <!-- æäº¤æŒ‰é’® -->
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-success btn-lg px-5 me-3">
                                    <i class="fas fa-calculator me-2"></i>è®¡ç®—æ–½è‚¥æ–¹æ¡ˆ
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg px-5" id="testDataBtn">
                                    <i class="fas fa-vial me-2"></i>æµ‹è¯•åœŸå£¤æ•°æ®
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                <div class="loading-spinner" id="loadingSpinner" role="status">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="loading-text" id="loadingText">æ­£åœ¨è·å–åœŸå£¤æ•°æ®å¹¶è®¡ç®—æ–½è‚¥æ–¹æ¡ˆ,è¯·ç¨å€™...</p>
                </div>

                <!-- ===== è¿‘ä¸‰å¹´äº§é‡ä¸æ–½è‚¥é‡å†å²æ•°æ®è¾“å…¥å¡ç‰‡ ===== -->
                <div class="card mb-4 fade-in" id="historicalDataCard">
                    <div class="card-header" style="background: linear-gradient(135deg, #1a7431 0%, #28a745 100%); color: white;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0 fs-5">
                                <i class="fas fa-chart-bar me-2"></i>è¿‘ä¸‰å¹´äº§é‡ä¸æ–½è‚¥å†å²æ•°æ®å½•å…¥
                            </h2>
                            <button type="button" class="btn btn-sm btn-light" id="toggleHistoricalBtn" style="opacity: 1 !important; visibility: visible !important;">
                                <i class="fas fa-chevron-down me-1"></i>å±•å¼€
                            </button>
                        </div>
                        <p class="mb-0 mt-1 opacity-75 small">å½•å…¥è¿‘ä¸‰å¹´å°éº¦å’Œæ°´ç¨»çš„å¹³å‡äº§é‡åŠæ°®ç£·é’¾ä½¿ç”¨é‡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—ä¸‰å¹´å‡å€¼å¹¶ä¿å­˜</p>
                    </div>
                    <div class="card-body p-4" id="historicalDataBody" style="display: none;">
                        <form id="historicalYieldForm" novalidate>
                            <!-- ä½ç½®ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ -->
                            <div class="mb-3">
                                <label for="histLocation" class="form-label fw-bold">
                                    <i class="fas fa-map-marker-alt me-1 text-success"></i>ç”°å—ä½ç½®ï¼ˆå¯é€‰ï¼‰
                                </label>
                                <input type="text" class="form-control" id="histLocation" placeholder="å¦‚ï¼šæ±Ÿè‹çœå—äº¬å¸‚æ±Ÿå®åŒºæŸæ‘">
                            </div>

                            <!-- æ°´ç¨»æ•°æ® -->
                            <div class="card mb-4 border-success">
                                <div class="card-header bg-success bg-opacity-10 border-success">
                                    <h5 class="mb-0 fw-bold text-success">
                                        <i class="me-2">ğŸŒ¾</i>æ°´ç¨» â€” è¿‘ä¸‰å¹´äº§é‡ä¸æ–½è‚¥æ•°æ®
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered align-middle text-center" style="min-width: 600px;">
                                            <thead class="table-success">
                                                <tr>
                                                    <th style="width:120px;">å¹´ä»½</th>
                                                    <th>äº§é‡<br><small class="text-muted">(å…¬æ–¤/äº©)</small></th>
                                                    <th>æ°®è‚¥ç”¨é‡N<br><small class="text-muted">(å…¬æ–¤/äº©)</small></th>
                                                    <th>ç£·è‚¥ç”¨é‡Pâ‚‚Oâ‚…<br><small class="text-muted">(å…¬æ–¤/äº©)</small></th>
                                                    <th>é’¾è‚¥ç”¨é‡Kâ‚‚O<br><small class="text-muted">(å…¬æ–¤/äº©)</small></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td class="fw-bold text-muted">ç¬¬ä¸€å¹´</td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y1_yield" min="0" max="2000" step="1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y1_n" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y1_p" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y1_k" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold text-muted">ç¬¬äºŒå¹´</td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y2_yield" min="0" max="2000" step="1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y2_n" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y2_p" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y2_k" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold text-muted">ç¬¬ä¸‰å¹´</td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y3_yield" min="0" max="2000" step="1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y3_n" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y3_p" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="rice_y3_k" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                </tr>
                                                <tr class="table-success fw-bold" id="riceAvgRow">
                                                    <td>ä¸‰å¹´å‡å€¼</td>
                                                    <td id="rice_avg_yield">â€”</td>
                                                    <td id="rice_avg_n">â€”</td>
                                                    <td id="rice_avg_p">â€”</td>
                                                    <td id="rice_avg_k">â€”</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- å°éº¦æ•°æ® -->
                            <div class="card mb-4 border-warning">
                                <div class="card-header bg-warning bg-opacity-10 border-warning">
                                    <h5 class="mb-0 fw-bold text-warning">
                                        <i class="me-2">ğŸŒ¿</i>å°éº¦ â€” è¿‘ä¸‰å¹´äº§é‡ä¸æ–½è‚¥æ•°æ®
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered align-middle text-center" style="min-width: 600px;">
                                            <thead class="table-warning">
                                                <tr>
                                                    <th style="width:120px;">å¹´ä»½</th>
                                                    <th>äº§é‡<br><small class="text-muted">(å…¬æ–¤/äº©)</small></th>
                                                    <th>æ°®è‚¥ç”¨é‡N<br><small class="text-muted">(å…¬æ–¤/äº©)</small></th>
                                                    <th>ç£·è‚¥ç”¨é‡Pâ‚‚Oâ‚…<br><small class="text-muted">(å…¬æ–¤/äº©)</small></th>
                                                    <th>é’¾è‚¥ç”¨é‡Kâ‚‚O<br><small class="text-muted">(å…¬æ–¤/äº©)</small></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td class="fw-bold text-muted">ç¬¬ä¸€å¹´</td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y1_yield" min="0" max="2000" step="1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y1_n" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y1_p" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y1_k" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold text-muted">ç¬¬äºŒå¹´</td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y2_yield" min="0" max="2000" step="1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y2_n" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y2_p" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y2_k" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold text-muted">ç¬¬ä¸‰å¹´</td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y3_yield" min="0" max="2000" step="1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y3_n" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y3_p" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                    <td><input type="number" class="form-control form-control-sm text-center" id="wheat_y3_k" min="0" max="100" step="0.1" placeholder="â€”"></td>
                                                </tr>
                                                <tr class="table-warning fw-bold" id="wheatAvgRow">
                                                    <td>ä¸‰å¹´å‡å€¼</td>
                                                    <td id="wheat_avg_yield">â€”</td>
                                                    <td id="wheat_avg_n">â€”</td>
                                                    <td id="wheat_avg_p">â€”</td>
                                                    <td id="wheat_avg_k">â€”</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- å¤‡æ³¨ -->
                            <div class="mb-3">
                                <label for="histNotes" class="form-label fw-bold">
                                    <i class="fas fa-sticky-note me-1 text-secondary"></i>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
                                </label>
                                <textarea class="form-control" id="histNotes" rows="2" placeholder="å¦‚ï¼šæœ‰æœºè‚¥ä½¿ç”¨æƒ…å†µã€ç‰¹æ®Šæ°”å€™è¯´æ˜ç­‰"></textarea>
                            </div>

                            <!-- æäº¤åé¦ˆ -->
                            <div id="historicalAlert" class="alert" style="display: none;" role="alert"></div>

                            <!-- æäº¤æŒ‰é’® -->
                            <div class="text-center mt-3">
                                <button type="submit" class="btn btn-success btn-lg px-5">
                                    <i class="fas fa-save me-2"></i>ä¿å­˜å†å²æ•°æ®
                                </button>
                                <button type="reset" class="btn btn-outline-secondary btn-lg px-4 ms-3" id="histResetBtn">
                                    <i class="fas fa-undo me-2"></i>é‡ç½®
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ç»“æœå±•ç¤ºåŒº -->
                <div class="result-section" id="resultSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 id="resultTitle" class="mb-0">
                            <i class="fas fa-clipboard-check me-2"></i>æ–½è‚¥æ–¹æ¡ˆæ¨è
                        </h3>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="printBtn">
                                <i class="fas fa-print me-1"></i>æ‰“å°æ–¹æ¡ˆ
                            </button>
                            <button class="btn btn-sm btn-outline-success" id="saveDataBtn">
                                <i class="fas fa-save me-1"></i>ä¿å­˜æ•°æ®
                            </button>
                        </div>
                    </div>
                    
                    <!-- åœŸå£¤å…»åˆ†ä¿¡æ¯ -->
                    <div class="card soil-card result-card">
                        <div class="card-body">
                            <h5 class="section-title">
                                <i class="fas fa-flask me-2"></i>åœŸå£¤å…»åˆ†ä¿¡æ¯
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded">
                                        <span class="fw-bold">ç¢±è§£æ°® (N):</span>
                                        <span>
                                            <span id="soilNValue" class="fs-5">--</span> mg/kg
                                            <span class="nutrient-badge nutrient-default" id="soilNLevel">--</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded">
                                        <span class="fw-bold">æœ‰æ•ˆç£· (P):</span>
                                        <span>
                                            <span id="soilPValue" class="fs-5">--</span> mg/kg
                                            <span class="nutrient-badge nutrient-default" id="soilPLevel">--</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded">
                                        <span class="fw-bold">æœ‰æ•ˆé’¾ (K):</span>
                                        <span>
                                            <span id="soilKValue" class="fs-5">--</span> mg/kg
                                            <span class="nutrient-badge nutrient-default" id="soilKLevel">--</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 small text-muted" id="soilDataSource">
                                <i class="fas fa-database me-1"></i>æ•°æ®æ¥æº: <span id="dataSourceText">ç­‰å¾…è®¡ç®—...</span>
                            </div>
                            <div class="mt-2 small" id="soilInputSourceInfo"></div>
                        </div>
                    </div>
                    
                    <!-- GAEZæ½œåœ¨äº§é‡ -->
                    <div class="card result-card mb-4" id="potentialYieldsContainer" style="display: none;">
                    </div>
                    
                    <div class="row mb-4">
                        <!-- åŸºæœ¬å‚æ•° -->
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 fertilizer-card result-card">
                                <div class="card-body">
                                    <h5 class="section-title">
                                        <i class="fas fa-cogs me-2"></i>åŸºæœ¬å‚æ•°
                                    </h5>
                                    <div id="basicParams"></div>
                                </div>
                            </div>
                        </div>
                        <!-- è‚¥æ–™ç”¨é‡ -->
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 result-card">
                                <div class="card-body">
                                    <h5 class="section-title">
                                        <i class="fas fa-weight me-2"></i>è‚¥æ–™ç”¨é‡ (å…¬æ–¤/äº©)
                                    </h5>
                                    <div id="fertilizerUsage"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <!-- æ–½è‚¥æ—¶æœŸå»ºè®® -->
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 result-card">
                                <div class="card-body">
                                    <h5 class="section-title">
                                        <i class="fas fa-calendar-alt me-2"></i>æ–½è‚¥æ—¶æœŸå»ºè®®
                                    </h5>
                                    <div id="stageAdvice"></div>
                                </div>
                            </div>
                        </div>
                        <!-- æ–½è‚¥æŒ‡å¯¼æ„è§ -->
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 advice-card result-card">
                                <div class="card-body">
                                    <h5 class="section-title">
                                        <i class="fas fa-lightbulb me-2"></i>æ–½è‚¥æŒ‡å¯¼æ„è§
                                    </h5>
                                    <div id="guidanceAdvice"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å…»åˆ†å¹³è¡¡è®¡ç®— -->
                    <div class="card param-card result-card">
                        <div class="card-body">
                            <h5 class="section-title">
                                <i class="fas fa-balance-scale me-2"></i>å…»åˆ†å¹³è¡¡è®¡ç®—
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-3">ä½œç‰©å…»åˆ†éœ€æ±‚</h6>
                                    <div id="nutrientDemand"></div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-3">åœŸå£¤å…»åˆ†ä¾›åº”</h6>
                                    <div id="soilSupply"></div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-3">è‚¥æ–™å…»åˆ†è¡¥å……</h6>
                                    <div id="fertilizerSupply"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¤©æ°”é¢„è­¦ä¿¡æ¯ -->
                    <div class="card result-card" id="weatherWarningCard" style="display: none;">
                        <div class="card-header bg-warning bg-opacity-25">
                            <h5 class="section-title mb-0">
                                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>å¤©æ°”é¢„è­¦ä¿¡æ¯
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- é¢„è­¦æ‘˜è¦ -->
                            <div id="weatherWarningSummary" class="mb-3"></div>
                            
                            <!-- å½“å‰å¤©æ°” -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="p-3 bg-light rounded">
                                        <h6 class="text-muted mb-2"><i class="fas fa-cloud-sun me-1"></i>å½“å‰å¤©æ°”</h6>
                                        <div id="currentWeatherInfo"></div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="p-3 bg-light rounded">
                                        <h6 class="text-muted mb-2"><i class="fas fa-calendar-week me-1"></i>æœªæ¥7å¤©é¢„æŠ¥</h6>
                                        <div id="forecastWeatherInfo"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ–½è‚¥é€‚å®œæ€§ -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2"><i class="fas fa-check-circle me-1"></i>æ–½è‚¥é€‚å®œæ€§åˆ†æ</h6>
                                <div id="fertilizerSuitability"></div>
                            </div>
                            
                            <!-- é¢„è­¦è¯¦æƒ… -->
                            <div id="weatherWarningDetails"></div>
                            
                            <!-- æ–½è‚¥å»ºè®® -->
                            <div class="mt-3">
                                <h6 class="text-muted mb-2"><i class="fas fa-lightbulb me-1"></i>æ–½è‚¥æ—¶æœºå»ºè®®</h6>
                                <div id="weatherBasedAdvice"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-success me-3" id="resetBtn">
                            <i class="fas fa-redo me-2"></i>é‡æ–°è®¡ç®—
                        </button>
                        <button class="btn btn-outline-success" id="exportBtn">
                            <i class="fas fa-file-export me-2"></i>å¯¼å‡ºæ–¹æ¡ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- é¡µè„š -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <h5>
                        <i class="fas fa-seedling me-2"></i>ç§‘å­¦æ–½è‚¥æ¨èç³»ç»Ÿ
                    </h5>
                    <p class="text-white-50">
                        åŸºäºåœ°ç†ä¿¡æ¯ç³»ç»Ÿ(GIS)å’ŒåœŸå£¤å…»åˆ†æ•°æ®åº“,æä¾›ç²¾å‡†æ–½è‚¥æŒ‡å¯¼
                    </p>
                    <p class="small text-white-50">
                        <i class="fas fa-map-marker-alt me-1"></i>è¦†ç›–èŒƒå›´:é•¿æ±Ÿä¸­ä¸‹æ¸¸åœ°åŒº
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-1">æŠ€æœ¯æ”¯æŒ:åä¸­å†œä¸šå¤§å­¦</p>
                    <p class="mb-0">Â© 2026 ç§‘å­¦æ–½è‚¥æ¨èç³»ç»Ÿ ç‰ˆæƒæ‰€æœ‰</p>
                    <p class="small text-white-50 mt-2">åœŸå£¤æ•°æ®æ¥æº:ä¸­å›½åœŸå£¤æ•°æ®åº“</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- æ¨¡æ€æ¡† - ä½¿ç”¨è¯´æ˜ -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">
                        <i class="fas fa-book me-2"></i>ç³»ç»Ÿä½¿ç”¨è¯´æ˜
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                </div>
                <div class="modal-body">
                    <h6><i class="fas fa-check-circle me-2 text-success"></i>ç³»ç»ŸåŠŸèƒ½</h6>
                    <ul>
                        <li>æ ¹æ®åœ°ç†ä½ç½®è·å–åœŸå£¤å…»åˆ†æ•°æ®</li>
                        <li>åŸºäºåœŸå£¤å…»åˆ†çŠ¶å†µè®¡ç®—ç²¾å‡†æ–½è‚¥æ–¹æ¡ˆ</li>
                        <li>è€ƒè™‘ä½œç‰©ç±»å‹ã€ç›®æ ‡äº§é‡ã€æ’­ç§æ—¥æœŸç­‰å› ç´ </li>
                        <li>æä¾›è¯¦ç»†çš„æ–½è‚¥æ—¶æœŸå’Œç”¨é‡å»ºè®®</li>
                    </ul>
                    
                    <h6><i class="fas fa-list-ol me-2 text-primary"></i>ä½¿ç”¨æ­¥éª¤</h6>
                    <ol>
                        <li>é€‰æ‹©ä½œç‰©ç±»å‹(æ°´ç¨»æˆ–å°éº¦)</li>
                        <li>è¾“å…¥é¢„æœŸçš„äº§é‡ç›®æ ‡</li>
                        <li>é€‰æ‹©æ’­ç§æ—¥æœŸ</li>
                        <li>è¾“å…¥ç”°å—çš„ç»çº¬åº¦åæ ‡</li>
                        <li>å¯é€‰:æ‰‹åŠ¨è¾“å…¥åœŸå£¤å…»åˆ†å€¼(ç¢±è§£æ°®ã€æœ‰æ•ˆç£·ã€æœ‰æ•ˆé’¾)</li>
                        <li>ç‚¹å‡»"è®¡ç®—æ–½è‚¥æ–¹æ¡ˆ"è·å–æ¨è</li>
                    </ol>
                    
                    <h6><i class="fas fa-vial me-2 text-warning"></i>åœŸå£¤å…»åˆ†è¾“å…¥è¯´æ˜</h6>
                    <ul>
                        <li>é»˜è®¤æƒ…å†µä¸‹,ç³»ç»Ÿæ ¹æ®ç»çº¬åº¦è‡ªåŠ¨ä»åœŸå£¤æ•°æ®åº“è·å–å…»åˆ†æ•°æ®</li>
                        <li>å¦‚æœå·²çŸ¥åœŸå£¤å…»åˆ†å€¼,å¯æ‰‹åŠ¨è¾“å…¥æ›´ç²¾ç¡®çš„æ•°æ®</li>
                        <li>æ‰‹åŠ¨è¾“å…¥æ•°æ®å°†ä¼˜å…ˆäºæ•°æ®åº“æ•°æ®</li>
                        <li>å»ºè®®ä½¿ç”¨å½“åœ°åœŸå£¤æ£€æµ‹æŠ¥å‘Šçš„æ•°æ®</li>
                    </ul>
                    
                    <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i>æ³¨æ„äº‹é¡¹</h6>
                    <ul>
                        <li>ç³»ç»Ÿé€‚ç”¨äºé•¿æ±Ÿä¸­ä¸‹æ¸¸åœ°åŒº</li>
                        <li>ç»çº¬åº¦èŒƒå›´:ç»åº¦110-122Â°,çº¬åº¦28-33Â°</li>
                        <li>äº§é‡èŒƒå›´:100-1000å…¬æ–¤/äº©</li>
                        <li>è®¡ç®—ç»“æœä»…ä¾›å‚è€ƒ,å®é™…åº”ç”¨éœ€ç»“åˆå½“åœ°æ¡ä»¶</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- é«˜å¾·åœ°å›¾ API -->
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '',
            serviceHost: ''
        }
    </script>
    <script type="text/javascript">
        // é«˜å¾·åœ°å›¾åŠ è½½è¶…æ—¶æ£€æŸ¥
        window.amapLoadTimeout = setTimeout(() => {
            console.error('é«˜å¾·åœ°å›¾åŠ è½½è¶…æ—¶ï¼ˆ10ç§’ï¼‰ï¼Œè¯·æ£€æŸ¥API Keyæ˜¯å¦æœ‰æ•ˆæˆ–ç½‘ç»œè¿æ¥');
            if (window._amapErrorCallback) {
                window._amapErrorCallback('åœ°å›¾åŠ è½½è¶…æ—¶');
            }
        }, 10000);
        
        window.onAMapLoaded = function() {
            clearTimeout(window.amapLoadTimeout);
            console.log('é«˜å¾·åœ°å›¾APIå·²åŠ è½½');
            if (window._amapReadyCallback) {
                window._amapReadyCallback();
            }
        };
    </script>
    <!-- âš ï¸ è¯·å°†ä¸‹é¢çš„ YOUR_API_KEY æ›¿æ¢ä¸ºä½ ä»é«˜å¾·å¹³å°è·å–çš„æœ‰æ•ˆ Key -->
    <script type="text/javascript"
            src="https://webapi.amap.com/maps?v=2.0&key=6ca92cc4bca5ecdd6ad1e15e318863e9"
            onerror="console.error('é«˜å¾·åœ°å›¾è„šæœ¬åŠ è½½å¤±è´¥')">
    </script>

    <!-- Application JavaScript -->
    <script src="static/js/app.js"></script>
    
    <!-- å†å²äº§é‡æ•°æ®å½•å…¥æ¨¡å—è„šæœ¬ -->
    <script>
    (function() {
        // ===== å±•å¼€/æŠ˜å æ§åˆ¶ =====
        const toggleBtn = document.getElementById('toggleHistoricalBtn');
        const dataBody = document.getElementById('historicalDataBody');
        if (toggleBtn && dataBody) {
            toggleBtn.addEventListener('click', function() {
                const isHidden = dataBody.style.display === 'none';
                dataBody.style.display = isHidden ? 'block' : 'none';
                toggleBtn.innerHTML = isHidden
                    ? '<i class="fas fa-chevron-down me-1"></i>å±•å¼€'
                    : '<i class="fas fa-chevron-up me-1"></i>æŠ˜å ';
            });

            // é»˜è®¤æŠ˜å çŠ¶æ€
            dataBody.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-chevron-down me-1"></i>å±•å¼€';
        }

        // ===== å®æ—¶è®¡ç®—å‡å€¼ =====
        function calcAvg(ids) {
            const nums = ids.map(id => {
                const v = parseFloat(document.getElementById(id) && document.getElementById(id).value);
                return isNaN(v) ? null : v;
            }).filter(v => v !== null);
            if (!nums.length) return null;
            return (nums.reduce((a, b) => a + b, 0) / nums.length).toFixed(2);
        }

        function updateAverages() {
            // æ°´ç¨»
            const riceFields = ['yield', 'n', 'p', 'k'];
            riceFields.forEach(f => {
                const avg = calcAvg([`rice_y1_${f}`, `rice_y2_${f}`, `rice_y3_${f}`]);
                const el = document.getElementById(`rice_avg_${f}`);
                if (el) el.textContent = avg !== null ? avg : 'â€”';
            });
            // å°éº¦
            riceFields.forEach(f => {
                const avg = calcAvg([`wheat_y1_${f}`, `wheat_y2_${f}`, `wheat_y3_${f}`]);
                const el = document.getElementById(`wheat_avg_${f}`);
                if (el) el.textContent = avg !== null ? avg : 'â€”';
            });
        }

        // ç›‘å¬æ‰€æœ‰è¾“å…¥æ¡†
        const inputIds = [
            'rice_y1_yield','rice_y2_yield','rice_y3_yield',
            'rice_y1_n','rice_y2_n','rice_y3_n',
            'rice_y1_p','rice_y2_p','rice_y3_p',
            'rice_y1_k','rice_y2_k','rice_y3_k',
            'wheat_y1_yield','wheat_y2_yield','wheat_y3_yield',
            'wheat_y1_n','wheat_y2_n','wheat_y3_n',
            'wheat_y1_p','wheat_y2_p','wheat_y3_p',
            'wheat_y1_k','wheat_y2_k','wheat_y3_k'
        ];
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateAverages);
        });

        // é‡ç½®æŒ‰é’®åŒæ­¥æ¸…ç©ºå‡å€¼è¡Œ
        const resetBtn = document.getElementById('histResetBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                setTimeout(updateAverages, 50);
            });
        }

        // ===== è¡¨å•æäº¤ =====
        const form = document.getElementById('historicalYieldForm');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const alertEl = document.getElementById('historicalAlert');
                alertEl.style.display = 'none';

                const getVal = id => {
                    const v = document.getElementById(id) ? document.getElementById(id).value : '';
                    return v === '' ? null : parseFloat(v);
                };

                const payload = {
                    location: (document.getElementById('histLocation') || {}).value || null,
                    notes: (document.getElementById('histNotes') || {}).value || null,
                    rice_year1_yield: getVal('rice_y1_yield'), rice_year2_yield: getVal('rice_y2_yield'), rice_year3_yield: getVal('rice_y3_yield'),
                    rice_year1_n: getVal('rice_y1_n'), rice_year2_n: getVal('rice_y2_n'), rice_year3_n: getVal('rice_y3_n'),
                    rice_year1_p: getVal('rice_y1_p'), rice_year2_p: getVal('rice_y2_p'), rice_year3_p: getVal('rice_y3_p'),
                    rice_year1_k: getVal('rice_y1_k'), rice_year2_k: getVal('rice_y2_k'), rice_year3_k: getVal('rice_y3_k'),
                    wheat_year1_yield: getVal('wheat_y1_yield'), wheat_year2_yield: getVal('wheat_y2_yield'), wheat_year3_yield: getVal('wheat_y3_yield'),
                    wheat_year1_n: getVal('wheat_y1_n'), wheat_year2_n: getVal('wheat_y2_n'), wheat_year3_n: getVal('wheat_y3_n'),
                    wheat_year1_p: getVal('wheat_y1_p'), wheat_year2_p: getVal('wheat_y2_p'), wheat_year3_p: getVal('wheat_y3_p'),
                    wheat_year1_k: getVal('wheat_y1_k'), wheat_year2_k: getVal('wheat_y2_k'), wheat_year3_k: getVal('wheat_y3_k')
                };

                // éªŒè¯ï¼šè‡³å°‘ä¸€ç»„æ•°æ®ä¸ä¸ºç©º
                const hasData = Object.values(payload).some(v => v !== null && typeof v === 'number');
                if (!hasData) {
                    alertEl.className = 'alert alert-warning';
                    alertEl.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>è¯·è‡³å°‘å¡«å†™ä¸€é¡¹äº§é‡æˆ–æ–½è‚¥æ•°æ®';
                    alertEl.style.display = 'block';
                    return;
                }

                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...';

                try {
                    const resp = await fetch('/api/historical_yield', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await resp.json();
                    if (result.success) {
                        const avg = result.averages;
                        alertEl.className = 'alert alert-success';
                        alertEl.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i><strong>æ•°æ®å·²æˆåŠŸä¿å­˜ï¼</strong>ï¼ˆè®°å½•ID: ${result.id}ï¼‰
                            <div class="mt-2 small">
                                <strong>æ°´ç¨»ä¸‰å¹´å‡å€¼ï¼š</strong>äº§é‡ ${avg.rice.yield ?? 'â€”'} kg/äº©ï¼Œ
                                N ${avg.rice.n ?? 'â€”'} kg/äº©ï¼ŒPâ‚‚Oâ‚… ${avg.rice.p ?? 'â€”'} kg/äº©ï¼ŒKâ‚‚O ${avg.rice.k ?? 'â€”'} kg/äº©
                                <br>
                                <strong>å°éº¦ä¸‰å¹´å‡å€¼ï¼š</strong>äº§é‡ ${avg.wheat.yield ?? 'â€”'} kg/äº©ï¼Œ
                                N ${avg.wheat.n ?? 'â€”'} kg/äº©ï¼ŒPâ‚‚Oâ‚… ${avg.wheat.p ?? 'â€”'} kg/äº©ï¼ŒKâ‚‚O ${avg.wheat.k ?? 'â€”'} kg/äº©
                            </div>`;
                    } else {
                        alertEl.className = 'alert alert-danger';
                        alertEl.innerHTML = `<i class="fas fa-times-circle me-2"></i>${result.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•'}`;
                    }
                } catch (err) {
                    alertEl.className = 'alert alert-danger';
                    alertEl.innerHTML = `<i class="fas fa-times-circle me-2"></i>ç½‘ç»œé”™è¯¯: ${err.message}`;
                } finally {
                    alertEl.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ä¿å­˜å†å²æ•°æ®';
                }
            });
        }
    })();
    </script>
</body>
</html>
