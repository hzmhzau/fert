# 科学施肥推荐系统 - 功能介绍说明

## 一、项目概述

科学施肥推荐系统是一个基于 GIS（地理信息系统）和土壤养分数据库的智能农业施肥决策平台，专为**长江中下游地区**的稻麦轮作农业设计。系统通过整合土壤养分数据、气象数据、作物生长模型和施肥专家知识，为农户提供精准、科学的施肥方案推荐。

### 技术架构

| 层级 | 技术方案 |
|------|----------|
| 前端 | HTML5 + CSS3 + JavaScript + Bootstrap 5 + 高德地图 API |
| 后端 | Node.js + Express |
| 数据存储 | JSON 文件数据库 / SQLite |
| 空间数据 | GeoTIFF + GeoJSON |
| 部署 | 支持 Cloudflare Workers / Render / 传统服务器 |

---

## 二、核心功能模块

### 2.1 智能定位与地图服务

系统提供多种定位方式，自动获取用户农田位置：

| 定位方式 | 优先级 | 说明 |
|----------|--------|------|
| GPS 定位 | 1 | 通过浏览器 Geolocation API 获取精确位置 |
| 网络定位 | 2 | 通过高德地图 IP 定位服务获取位置 |
| 默认位置 | 3 | 默认定位到南京（经度 118.763，纬度 32.057） |

**地图功能**：
- 交互式地图选点，支持点击/拖拽选择农田位置
- 地址搜索与反向地理编码
- 地图标记点管理

### 2.2 土壤养分数据获取

系统通过 GeoTIFF 栅格数据提供空间化的土壤养分信息：

| 养分指标 | 数据文件 | 单位 | 说明 |
|----------|----------|------|------|
| 碱解氮 (AN) | `GTiff/AN_5-15cm_1km_clip.tif` | mg/kg | 土壤有效氮含量 |
| 有效磷 (AP) | `GTiff/AP_5-15cm_1km_clip.tif` | mg/kg | 土壤有效磷含量 |
| 速效钾 (AK) | `GTiff/AK_5-15cm_1km_clip.tif` | mg/kg | 土壤有效钾含量 |

**数据来源**：1km×1km 网格分辨率的土壤养分空间分布数据，深度为 5-15cm 耕层。

**养分水平分级**：

| 养分 | 极低 | 低 | 中等 | 高 | 极高 |
|------|------|-----|------|-----|------|
| 碱解氮 | <60 | 60-90 | 90-120 | 120-150 | >150 |
| 有效磷 | <5 | 5-10 | 10-20 | 20-40 | >40 |
| 速效钾 | <50 | 50-100 | 100-150 | 150-200 | >200 |

### 2.3 施肥方案计算

基于目标产量法，结合区域肥料利用率数据，计算推荐施肥量：

**计算公式**：
```
施肥量(kg/亩) = (目标产量 × 单位产量养分吸收量 - 土壤供肥量) / (肥料养分含量 × 肥料利用率)
```

**参数配置**：

| 作物 | 目标产量范围 | 单位产量吸氮量 | 单位产量吸磷量 | 单位产量吸钾量 |
|------|--------------|----------------|----------------|----------------|
| 水稻 | 400-700 kg/亩 | 0.02 kg | 0.01 kg | 0.025 kg |
| 冬小麦 | 300-500 kg/亩 | 0.025 kg | 0.01 kg | 0.02 kg |

**区域肥料利用率**：

系统内置长江中下游各地区稻麦轮作的肥料利用率数据，以 GeoJSON 格式存储：

| 地区 | 作物 | 氮肥利用率 | 磷肥利用率 | 钾肥利用率 |
|------|------|------------|------------|------------|
| 襄阳 | 冬小麦 | 40%-50% | 20%-25% | 50%-60% |
| 武汉 | 水稻 | 32%-40% | 15%-22% | 40%-50% |
| 扬州 | 冬小麦 | 25%-30% | 15%-20% | 35%-45% |
| ... | ... | ... | ... | ... |

### 2.4 农时指导服务

系统提供区域化的农时表，指导农户合理安排农事活动：

**播种期建议**（以部分城市为例）：

| 地区 | 冬小麦播种期 | 水稻栽插期 | 备注 |
|------|--------------|------------|------|
| 襄阳 | 10月20日-11月5日 | 5月20日-6月5日 | 鄂北岗地，播期较早 |
| 武汉 | 10月30日-11月15日 | 5月25日-6月15日 | 江汉平原，播期较晚 |
| 合肥 | 10月25日-11月10日 | 5月20日-6月5日 | 抢水栽插 |
| 扬州 | 10月25日-11月5日 | 6月1日-6月15日 | 里下河，抢晴 |

### 2.5 气象数据服务

集成 Open-Meteo 免费 API，获取实时和预测气象数据：

- 温度（当前、最高、最低）
- 相对湿度
- 降水量
- 风速风向
- 土壤温湿度

气象数据用于优化施肥时机建议，避免不利天气施肥。

### 2.6 数据持久化

系统自动保存用户的计算记录，便于追溯和分析：

**存储内容**：
- 作物类型与目标产量
- 地理坐标
- 土壤养分数据
- 施肥推荐结果
- 用户会话信息

**存储方式**：JSON 文件数据库（`fertilizer_data.json`），支持跨平台运行。

---

## 三、API 接口说明

### 3.1 核心接口

| 方法 | 路径 | 功能描述 |
|------|------|----------|
| GET | `/` | 返回前端页面 |
| GET | `/health` | 健康检查 |
| POST | `/calculate` | 计算施肥方案 |
| GET | `/test_geotiff` | 获取土壤养分数据（通过坐标） |

### 3.2 业务接口

| 方法 | 路径 | 功能描述 |
|------|------|----------|
| GET | `/api/weather` | 获取气象数据 |
| POST | `/api/fertilizer_timing` | 获取施肥时机建议 |
| POST | `/api/simulate` | 离线模拟计算 |
| GET/POST | `/api/amap_proxy` | 高德地图 API 代理 |
| GET | `/api/map_config` | 获取地图配置 |

### 3.3 计算接口示例

**请求**：
```json
POST /calculate
{
    "crop_type": "水稻",
    "target_yield": 600,
    "longitude": 118.763,
    "latitude": 32.057,
    "sowing_date": "2024-06-01"
}
```

**响应**：
```json
{
    "success": true,
    "data": {
        "fertilizer_recommendation": {
            "N": 12.5,
            "P2O5": 4.8,
            "K2O": 8.2
        },
        "soil_nutrients": {
            "AN": { "value": 95.2, "level": "中等" },
            "AP": { "value": 15.3, "level": "中等" },
            "AK": { "value": 120.5, "level": "中等" }
        },
        "timing_advice": "建议在播种前7-10天施基肥..."
    }
}
```

---

## 四、部署方案

### 4.1 本地开发

```bash
# 安装依赖
npm install

# 开发模式（热重载）
npm run dev

# 生产模式
npm start
```

服务默认运行在 `http://localhost:5000`

### 4.2 Cloudflare Workers 部署

```bash
# 部署到 Cloudflare Pages
npm run deploy:pages

# 部署到 Cloudflare Workers
npm run deploy:worker
```

### 4.3 Render 部署

项目包含 `render.yaml` 配置文件，可直接连接 GitHub 仓库自动部署。

---

## 五、数据文件说明

| 文件名 | 类型 | 说明 |
|--------|------|------|
| `长江中下游稻麦轮作肥料利用率.geojson` | GeoJSON | 各地区氮磷钾肥料利用率数据 |
| `长江中下游稻麦轮作农时表.geojson` | GeoJSON | 各地区播种/栽插时间表 |
| `GTiff/AN_5-15cm_1km_clip.tif` | GeoTIFF | 土壤碱解氮空间分布 |
| `GTiff/AP_5-15cm_1km_clip.tif` | GeoTIFF | 土壤有效磷空间分布 |
| `GTiff/AK_5-15cm_1km_clip.tif` | GeoTIFF | 土壤速效钾空间分布 |
| `fertilizer_data.json` | JSON | 用户计算记录数据库 |

---

## 六、系统特色

### 6.1 精准定位施肥

- 基于地理坐标自动获取土壤养分数据
- 考虑区域差异的肥料利用率参数
- 1km×1km 空间分辨率的土壤数据支持

### 6.2 离线数据支持

- 系统内置默认养分参数，无网络时可正常使用
- 支持手动输入土壤检测数据
- 前端缓存策略优化用户体验

### 6.3 多平台部署

- 传统服务器部署
- Serverless 架构（Cloudflare Workers）
- 容器化部署支持

### 6.4 用户友好界面

- 响应式设计，适配移动端
- 交互式地图选点
- 可视化养分水平展示
- 详细的施肥建议说明

---

## 七、适用范围

本系统适用于以下地区：

- **湖北省**：襄阳、随州、武汉、荆州、孝感
- **安徽省**：合肥、安庆、芜湖
- **江苏省**：扬州、泰州、南通
- **江西省**：南昌
- **浙江省**：杭州
- **湖南省**：长沙
- **上海市**

---

## 八、版本信息

- **版本号**：v1.0.0
- **开发语言**：JavaScript (Node.js)
- **运行环境**：Node.js >= 16.0.0
- **开源协议**：MIT License

---

## 九、联系方式

如有问题或建议，请通过项目仓库提交 Issue。